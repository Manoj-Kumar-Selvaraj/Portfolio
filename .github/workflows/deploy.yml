name: Deploy Jenkins (Azure Run Command)

on:
  push:
    branches: [ Azure-Scripts ]

  workflow_dispatch:
    inputs:
      force:
        description: "Global force"
        default: "false"
      force_nginx:
        description: "Force nginx"
        default: "false"
      force_controller:
        description: "Force controller"
        default: "false"
      force_agent:
        description: "Force agent"
        default: "false"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------
      # Checkout (only to read commit message)
      # -----------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # -----------------------------------------
      # Resolve FORCE flags (runner-side)
      # -----------------------------------------
      - name: Resolve force flags
        shell: bash
        run: |
          normalize() {
            case "${1,,}" in true|1|yes) echo 1 ;; *) echo 0 ;; esac
          }

          FORCE=0 FORCE_NGINX=0 FORCE_CONTROLLER=0 FORCE_AGENT=0

          if [[ "$GITHUB_EVENT_NAME" == "push" ]]; then
            msg="$(git log -1 --pretty=%B | tr '[:upper:]' '[:lower:]')"
            [[ "$msg" =~ \[force\] ]] && FORCE=1
            [[ "$msg" =~ \[force-nginx\] ]] && FORCE_NGINX=1
            [[ "$msg" =~ \[force-controller\] ]] && FORCE_CONTROLLER=1
            [[ "$msg" =~ \[force-agent\] ]] && FORCE_AGENT=1
          else
            FORCE="$(normalize "${{ github.event.inputs.force }}")"
            FORCE_NGINX="$(normalize "${{ github.event.inputs.force_nginx }}")"
            FORCE_CONTROLLER="$(normalize "${{ github.event.inputs.force_controller }}")"
            FORCE_AGENT="$(normalize "${{ github.event.inputs.force_agent }}")"
          fi

          [[ "$FORCE_NGINX" -eq 0 ]] && FORCE_NGINX="$FORCE"
          [[ "$FORCE_CONTROLLER" -eq 0 ]] && FORCE_CONTROLLER="$FORCE"
          [[ "$FORCE_AGENT" -eq 0 ]] && FORCE_AGENT="$FORCE"

          echo "FORCE=$FORCE" >> $GITHUB_ENV
          echo "FORCE_NGINX=$FORCE_NGINX" >> $GITHUB_ENV
          echo "FORCE_CONTROLLER=$FORCE_CONTROLLER" >> $GITHUB_ENV
          echo "FORCE_AGENT=$FORCE_AGENT" >> $GITHUB_ENV


      # -----------------------------------------
      # Azure Login (OIDC â€“ no secrets)
      # -----------------------------------------
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # -----------------------------------------
      # Run Command (THIS REPLACES SSH)
      # -----------------------------------------
      - name: Run Jenkins install via Azure Run Command
        run: |
          az vm run-command invoke \
            --resource-group portfolio-rg \
            --name jenkins-vm \
            --command-id RunShellScript \
            --parameters \
              FORCE=${FORCE} \
              FORCE_NGINX=${FORCE_NGINX} \
              FORCE_CONTROLLER=${FORCE_CONTROLLER} \
              FORCE_AGENT=${FORCE_AGENT} \
              AZURE_KV_NAME=${{ secrets.AZURE_KV_NAME }} \
              KV_SECRET_NAME=${{ secrets.KV_SECRET_NAME }} \
            --scripts @install.sh
