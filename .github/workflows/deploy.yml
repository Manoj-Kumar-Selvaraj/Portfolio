name: Deploy Jenkins Scripts to VM

on:
  push:
    branches:
      - Azure-Scripts
  workflow_dispatch:   # ðŸ‘ˆ Enables manual trigger
    inputs:
      reason:
        description: "Reason for manual run"
        required: false
      force:
        description: "Global force flag (true/false). Falls back if per-component flags unset."
        required: false
        default: 'false'
      force_nginx:
        description: "Force Nginx reconfiguration (true/false)."
        required: false
        default: 'true'
      force_controller:
        description: "Force Jenkins controller reconfiguration (true/false)."
        required: false
        default: 'false'
      force_agent:
        description: "Force Jenkins agent reconfiguration (true/false)."
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Jenkins scripts to VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_IP }}
          username: azureuser
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          timeout: 10m
          script: |
            set -euxo pipefail

            echo "==> Stopping services (if running)"
            sudo systemctl stop jenkins-idle-shutdown || true

            echo "==> Cleaning old repo"
            sudo rm -rf /opt/jenkins-install

            echo "==> Fresh clone from GitHub"
            sudo git clone -b Azure-Scripts \
              https://github.com/Manoj-Kumar-Selvaraj/Portfolio.git \
              /opt/jenkins-install

            echo "==> Ensuring install script is executable"
            sudo chmod -R +x /opt/jenkins-install/scripts/*
            cd /opt/jenkins-install

            echo "==> Exporting Key Vault variables from GitHub secrets"
            # These should be configured in the repository secrets
            export AZURE_KV_NAME="${{ secrets.AZURE_KV_NAME }}"
            export KV_SECRET_NAME="${{ secrets.KV_SECRET_NAME }}"

            # Normalize global FORCE input from workflow_dispatch into FORCE=0/1
            FORCE_INPUT='${{ github.event.inputs.force }}'
            if [ -z "$FORCE_INPUT" ]; then FORCE_INPUT='false'; fi
            case "$(echo "$FORCE_INPUT" | tr '[:upper:]' '[:lower:]')" in
              1|true|yes) FORCE=1 ;;
              *) FORCE=0 ;;
            esac
            export FORCE

            # Normalize per-component FORCE inputs (empty => inherit global)
            normalize_flag() {
              local raw="$1"; local default="$2"
              if [ -z "$raw" ]; then
                echo "$default"
                return
              fi
              case "$(echo "$raw" | tr '[:upper:]' '[:lower:]')" in
                1|true|yes) echo 1 ;;
                *) echo 0 ;;
              esac
            }

            FORCE_NGINX=$(normalize_flag '${{ github.event.inputs.force_nginx }}' "$FORCE")
            FORCE_CONTROLLER=$(normalize_flag '${{ github.event.inputs.force_controller }}' "$FORCE")
            FORCE_AGENT=$(normalize_flag '${{ github.event.inputs.force_agent }}' "$FORCE")
            export FORCE_NGINX FORCE_CONTROLLER FORCE_AGENT

            echo "==> Running install.sh"
            sudo FORCE="$FORCE" FORCE_NGINX="$FORCE_NGINX" FORCE_CONTROLLER="$FORCE_CONTROLLER" FORCE_AGENT="$FORCE_AGENT" AZURE_KV_NAME="$AZURE_KV_NAME" KV_SECRET_NAME="$KV_SECRET_NAME" bash /opt/jenkins-install/scripts/install.sh

            echo "==> Ensuring Jenkins nginx access log exists"
            sudo mkdir -p /var/log/nginx
            sudo touch /var/log/nginx/jenkins.access.log
            sudo chown www-data:adm /var/log/nginx/jenkins.access.log || true
            sudo chmod 0640 /var/log/nginx/jenkins.access.log || true

            echo "==> Reloading systemd and enabling service"
            sudo systemctl daemon-reload
            sudo systemctl enable --now jenkins-idle-shutdown.service

            echo "==> Restarting nginx"
            sudo systemctl restart nginx || true

            echo "==> Service status and recent logs for verification"
            sudo systemctl status jenkins-idle-shutdown --no-pager || true
            sudo journalctl -u jenkins-idle-shutdown --no-pager -n 200 || true

            echo "==> Deployment completed successfully"
