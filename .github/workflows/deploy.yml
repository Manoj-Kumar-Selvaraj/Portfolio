name: Deploy Jenkins Scripts to VM

on:
  push:
    branches:
      - Azure-Scripts
  workflow_dispatch:   # ðŸ‘ˆ Enables manual trigger
    inputs:
    reason:
      description: "Reason for manual run"
      required: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Jenkins scripts to VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_IP }}
          username: azureuser
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          timeout: 10m
          script: |
            set -euxo pipefail

            echo "==> Stopping services (if running)"
            sudo systemctl stop jenkins-idle-shutdown || true

            echo "==> Cleaning old repo"
            sudo rm -rf /opt/jenkins-install

            echo "==> Fresh clone from GitHub"
            sudo git clone -b Azure-Scripts \
              https://github.com/Manoj-Kumar-Selvaraj/Portfolio.git \
              /opt/jenkins-install

            echo "==> Ensuring install script is executable"
            sudo chmod -R +x /opt/jenkins-install/scripts/*
            cd /opt/jenkins-install

            echo "==> Exporting Key Vault variables from GitHub secrets"
            # These should be configured in the repository secrets
            export AZURE_KV_NAME="${{ secrets.AZURE_KV_NAME }}"
            export KV_SECRET_NAME="${{ secrets.KV_SECRET_NAME }}"

            echo "==> Running install.sh"
            sudo AZURE_KV_NAME="$AZURE_KV_NAME" KV_SECRET_NAME="$KV_SECRET_NAME" bash /opt/jenkins-install/scripts/install.sh

            echo "==> Ensuring Jenkins nginx access log exists"
            sudo mkdir -p /var/log/nginx
            sudo touch /var/log/nginx/jenkins.access.log
            sudo chown www-data:adm /var/log/nginx/jenkins.access.log || true
            sudo chmod 0640 /var/log/nginx/jenkins.access.log || true

            echo "==> Reloading systemd and enabling service"
            sudo systemctl daemon-reload
            sudo systemctl enable --now jenkins-idle-shutdown.service

            echo "==> Restarting nginx"
            sudo systemctl restart nginx || true

            echo "==> Service status and recent logs for verification"
            sudo systemctl status jenkins-idle-shutdown --no-pager || true
            sudo journalctl -u jenkins-idle-shutdown --no-pager -n 200 || true

            echo "==> Deployment completed successfully"
