name: Deploy Jenkins Scripts to VM

on:
  push:
    branches:
      - Azure-Scripts
  workflow_dispatch:   # ðŸ‘ˆ Enables manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Jenkins scripts to VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_IP }}
          username: azureuser
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          timeout: 10m
          script: |
            set -euxo pipefail

            echo "==> Stopping services (if running)"
            sudo systemctl stop jenkins-idle-shutdown || true

            echo "==> Cleaning old repo"
            sudo rm -rf /opt/jenkins-install

            echo "==> Fresh clone from GitHub"
            sudo git clone -b Azure-Scripts \
              https://github.com/Manoj-Kumar-Selvaraj/Portfolio.git \
              /opt/jenkins-install

            echo "==> Ensuring install script is executable"
            sudo chmod -R +x /opt/jenkins-install/scripts/*
            cd /opt/jenkins-install

            echo "==> Running install.sh"
            sudo bash /opt/jenkins-install/scripts/install.sh

            echo "==> Deployment completed successfully"
