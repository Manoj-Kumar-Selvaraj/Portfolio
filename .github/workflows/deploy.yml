name: Deploy Jenkins Scripts to VM

on:
  push:
    branches:
      - Azure-Scripts
  workflow_dispatch:   # ðŸ‘ˆ Enables manual trigger
    inputs:
      reason:
        description: "Reason for manual run"
        required: false
      force:
        description: "Global force flag (true/false). Falls back if per-component flags unset."
        required: false
        default: 'false'
      force_nginx:
        description: "Force Nginx reconfiguration (true/false)."
        required: false
        default: 'true'
      force_controller:
        description: "Force Jenkins controller reconfiguration (true/false)."
        required: false
        default: 'false'
      force_agent:
        description: "Force Jenkins agent reconfiguration (true/false)."
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Jenkins scripts to VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_IP }}
          username: azureuser
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          timeout: 10m
          script: |
            set -euxo pipefail

            echo "==> Stopping services (if running)"
            sudo systemctl stop jenkins-idle-shutdown || true

            echo "==> Cleaning old repo"
            sudo rm -rf /opt/jenkins-install

            echo "==> Fresh clone from GitHub"
            sudo git clone -b Azure-Scripts \
              https://github.com/Manoj-Kumar-Selvaraj/Portfolio.git \
              /opt/jenkins-install

            echo "==> Ensuring install script is executable"
            sudo chmod -R +x /opt/jenkins-install/scripts/*
            cd /opt/jenkins-install

            echo "==> Exporting Key Vault variables from GitHub secrets"
            # These should be configured in the repository secrets
            export AZURE_KV_NAME="${{ secrets.AZURE_KV_NAME }}"
            export KV_SECRET_NAME="${{ secrets.KV_SECRET_NAME }}"

            # Determine force flags for push vs manual run
            if [ "${GITHUB_EVENT_NAME:-}" = "push" ]; then
              # Read commit message from event payload (if available)
              if [ -n "${GITHUB_EVENT_PATH:-}" ] && [ -f "${GITHUB_EVENT_PATH}" ]; then
                commit_msg="$(jq -r .head_commit.message "${GITHUB_EVENT_PATH}" 2>/dev/null || true)"
              else
                commit_msg=""
              fi

              commit_msg_lc="$(echo "${commit_msg}" | tr '[:upper:]' '[:lower:]')"

              # Global marker
              if echo "$commit_msg_lc" | grep -q '\[force\]'; then
                FORCE_INPUT='true'
              else
                FORCE_INPUT='false'
              fi

              # Per-component markers (empty string means inherit)
              FORCE_NGINX="$(echo "$commit_msg_lc" | grep -q '\[force-nginx\]' && echo 'true' || echo '')"
              FORCE_CONTROLLER="$(echo "$commit_msg_lc" | grep -q '\[force-controller\]' && echo 'true' || echo '')"
              FORCE_AGENT="$(echo "$commit_msg_lc" | grep -q '\[force-agent\]' && echo 'true' || echo '')"
            else
              # Manual run: read inputs (will use YAML defaults if unset)
              FORCE_INPUT='${{ github.event.inputs.force }}'
              FORCE_NGINX='${{ github.event.inputs.force_nginx }}'
              FORCE_CONTROLLER='${{ github.event.inputs.force_controller }}'
              FORCE_AGENT='${{ github.event.inputs.force_agent }}'
            fi

            # Normalize helper: 'true|1|yes' -> 1, empty -> '', otherwise 0
            normalize() {
              case "$(echo "${1:-}" | tr '[:upper:]' '[:lower:]')" in
                1|true|yes) echo 1 ;;
                '') echo '' ;;
                *) echo 0 ;;
              esac
            }

            FORCE="$(normalize "$FORCE_INPUT")"
            FORCE_NGINX="$(normalize "${FORCE_NGINX:-}")"
            if [ -z "$FORCE_NGINX" ]; then FORCE_NGINX="$FORCE"; fi
            FORCE_CONTROLLER="$(normalize "${FORCE_CONTROLLER:-}")"
            if [ -z "$FORCE_CONTROLLER" ]; then FORCE_CONTROLLER="$FORCE"; fi
            FORCE_AGENT="$(normalize "${FORCE_AGENT:-}")"
            if [ -z "$FORCE_AGENT" ]; then FORCE_AGENT="$FORCE"; fi

            export FORCE FORCE_NGINX FORCE_CONTROLLER FORCE_AGENT

            echo "==> Running install.sh"
            sudo FORCE="$FORCE" FORCE_NGINX="$FORCE_NGINX" FORCE_CONTROLLER="$FORCE_CONTROLLER" FORCE_AGENT="$FORCE_AGENT" AZURE_KV_NAME="$AZURE_KV_NAME" KV_SECRET_NAME="$KV_SECRET_NAME" bash /opt/jenkins-install/scripts/install.sh

            echo "==> Ensuring Jenkins nginx access log exists"
            sudo mkdir -p /var/log/nginx
            sudo touch /var/log/nginx/jenkins.access.log
            sudo chown www-data:adm /var/log/nginx/jenkins.access.log || true
            sudo chmod 0640 /var/log/nginx/jenkins.access.log || true

            echo "==> Reloading systemd and enabling service"
            sudo systemctl daemon-reload
            sudo systemctl enable --now jenkins-idle-shutdown.service

            echo "==> Restarting nginx"
            sudo systemctl restart nginx || true

            echo "==> Service status and recent logs for verification"
            sudo systemctl status jenkins-idle-shutdown --no-pager || true
            sudo journalctl -u jenkins-idle-shutdown --no-pager -n 200 || true

            echo "==> Deployment completed successfully"
