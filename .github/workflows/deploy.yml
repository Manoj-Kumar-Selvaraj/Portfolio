name: Deploy Jenkins (Azure Run Command)

on:
  push:
    branches: [ Azure-Scripts ]

  workflow_dispatch:
    inputs:
      force:
        description: "Global force"
        default: "false"
      force_nginx:
        description: "Force nginx"
        default: "false"
      force_controller:
        description: "Force controller"
        default: "false"
      force_agent:
        description: "Force agent"
        default: "false"

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # Checkout (only for commit message parsing)
      # --------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # --------------------------------------------------
      # Resolve FORCE flags (runner-side only)
      # --------------------------------------------------
      - name: Resolve force flags
        shell: bash
        run: |
          set -euo pipefail

          normalize() {
            case "${1,,}" in true|1|yes) echo 1 ;; *) echo 0 ;; esac
          }

          FORCE=0 FORCE_NGINX=0 FORCE_CONTROLLER=0 FORCE_AGENT=0

          if [[ "$GITHUB_EVENT_NAME" == "push" ]]; then
            msg="$(git log -1 --pretty=%B | tr '[:upper:]' '[:lower:]')"
            [[ "$msg" =~ \[force\] ]] && FORCE=1
            [[ "$msg" =~ \[force-nginx\] ]] && FORCE_NGINX=1
            [[ "$msg" =~ \[force-controller\] ]] && FORCE_CONTROLLER=1
            [[ "$msg" =~ \[force-agent\] ]] && FORCE_AGENT=1
          else
            FORCE="$(normalize "${{ github.event.inputs.force }}")"
            FORCE_NGINX="$(normalize "${{ github.event.inputs.force_nginx }}")"
            FORCE_CONTROLLER="$(normalize "${{ github.event.inputs.force_controller }}")"
            FORCE_AGENT="$(normalize "${{ github.event.inputs.force_agent }}")"
          fi

          [[ "$FORCE_NGINX" -eq 0 ]] && FORCE_NGINX="$FORCE"
          [[ "$FORCE_CONTROLLER" -eq 0 ]] && FORCE_CONTROLLER="$FORCE"
          [[ "$FORCE_AGENT" -eq 0 ]] && FORCE_AGENT="$FORCE"

          {
            echo "FORCE=$FORCE"
            echo "FORCE_NGINX=$FORCE_NGINX"
            echo "FORCE_CONTROLLER=$FORCE_CONTROLLER"
            echo "FORCE_AGENT=$FORCE_AGENT"
          } >> "$GITHUB_ENV"

      # --------------------------------------------------
      # Azure Login (OIDC â€“ no secrets)
      # --------------------------------------------------
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # --------------------------------------------------
      # Ensure VM is running
      # --------------------------------------------------
      - name: Ensure Jenkins VM is running
        shell: bash
        run: |
          set -euo pipefail

          RG="portfolio-rg"
          VM="jenkins-vm"

          echo "Checking VM power state..."
          STATE=$(az vm get-instance-view \
            -g "$RG" \
            -n "$VM" \
            --query "instanceView.statuses[?starts_with(code,'PowerState/')].displayStatus" \
            -o tsv)

          echo "Current state: $STATE"

          if [[ "$STATE" == "VM deallocated" || "$STATE" == "VM stopped" ]]; then
            echo "Starting VM..."
            az vm start -g "$RG" -n "$VM"
          else
            echo "VM already running"
          fi
          echo "Waiting for VM to reach 'VM running' state..."

          for i in {1..30}; do
            STATE=$(az vm get-instance-view \
              -g "$RG" \
              -n "$VM" \
              --query "instanceView.statuses[?starts_with(code,'PowerState/')].displayStatus" \
              -o tsv)

            echo "Current state: $STATE"

            if [[ "$STATE" == "VM running" ]]; then
              echo "VM is running"
              break
            fi

            sleep 10
          done

          if [[ "$STATE" != "VM running" ]]; then
            echo "ERROR: VM did not reach running state in time"
            exit 1
          fi

          echo "Waiting for Azure agent readiness..."
          sleep 30


      # --------------------------------------------------
      # Azure Run Command (authoritative execution)
      # --------------------------------------------------
      - name: Run Jenkins install via Azure Run Command
        shell: bash
        run: |
          az vm run-command invoke \
            --resource-group portfolio-rg \
            --name jenkins-vm \
            --command-id RunShellScript \
            --parameters \
              FORCE=${{ env.FORCE }} \
              FORCE_NGINX=${{ env.FORCE_NGINX }} \
              FORCE_CONTROLLER=${{ env.FORCE_CONTROLLER }} \
              FORCE_AGENT=${{ env.FORCE_AGENT }} \
              AZURE_KV_NAME=${{ secrets.AZURE_KV_NAME }} \
              KV_SECRET_NAME=${{ secrets.KV_SECRET_NAME }} \
            --scripts '
                bash -c "
                  set -Eeuo pipefail

                  VM_NAME=jenkins-vm
                  RESOURCE_GROUP=portfolio-rg
                  INSTALL_DIR=/opt/jenkins-install
                  LOG_FILE=/var/log/jenkins-install.log

                  mkdir -p /var/log
                  touch \"\$LOG_FILE\"
                  exec >>\"\$LOG_FILE\" 2>&1

                  echo \"=====================================\"
                  echo \"Jenkins install started at \$(date -u)\"
                  echo \"VM=\$VM_NAME RG=\$RESOURCE_GROUP\"
                  echo \"FORCE=\$FORCE\"
                  echo \"FORCE_NGINX=\$FORCE_NGINX\"
                  echo \"FORCE_CONTROLLER=\$FORCE_CONTROLLER\"
                  echo \"FORCE_AGENT=\$FORCE_AGENT\"
                  echo \"=====================================\"

                  if [[ -z \"\$AZURE_KV_NAME\" || -z \"\$KV_SECRET_NAME\" ]]; then
                    echo \"ERROR: Azure Key Vault variables missing\"
                    exit 1
                  fi

                  rm -rf \"\$INSTALL_DIR\"
                  git clone -b Azure-Scripts \
                    https://github.com/Manoj-Kumar-Selvaraj/Portfolio.git \
                    \"\$INSTALL_DIR\"

                  cd \"\$INSTALL_DIR\"
                  chmod -R +x scripts

                  env \
                    FORCE=\"\$FORCE\" \
                    FORCE_NGINX=\"\$FORCE_NGINX\" \
                    FORCE_CONTROLLER=\"\$FORCE_CONTROLLER\" \
                    FORCE_AGENT=\"\$FORCE_AGENT\" \
                    AZURE_KV_NAME=\"\$AZURE_KV_NAME\" \
                    KV_SECRET_NAME=\"\$KV_SECRET_NAME\" \
                    bash scripts/install.sh

                  echo \"Jenkins install completed at \$(date -u)\"
                "
              '